create extension if not exists "postgis" with schema "extensions";

create extension if not exists "vector" with schema "extensions";

create sequence "public"."placemark_history_id_seq";

create sequence "public"."placemarks_id_seq";

create sequence "public"."site_elements_id_seq";

create sequence "public"."visit_records_id_seq";

create sequence "public"."visits_id_seq";


  create table "public"."QGIS" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "geometry" extensions.geometry,
    "created_by" uuid
      );



  create table "public"."_migration_hotspot_mapping" (
    "panorama_id" uuid not null,
    "old_hotspot_uuid" uuid not null,
    "array_position" integer not null,
    "new_hotspot_id" bigint not null
      );


alter table "public"."_migration_hotspot_mapping" enable row level security;


  create table "public"."_migration_location_to_visit" (
    "old_location_id" uuid not null,
    "new_visit_id" bigint
      );


alter table "public"."_migration_location_to_visit" enable row level security;


  create table "public"."_migration_placemark_mapping" (
    "old_placemark_id" bigint not null,
    "new_placemark_id" bigint,
    "visit_record_id" bigint
      );


alter table "public"."_migration_placemark_mapping" enable row level security;


  create table "public"."clip_embeddings" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "embeddings" extensions.vector(512) not null,
    "placemark_image_id" uuid
      );


alter table "public"."clip_embeddings" enable row level security;


  create table "public"."companies" (
    "id" uuid not null default extensions.uuid_generate_v4(),
    "name" text not null,
    "created_at" timestamp with time zone default now()
      );


alter table "public"."companies" enable row level security;


  create table "public"."export_jobs" (
    "id" uuid not null default gen_random_uuid(),
    "user_id" uuid,
    "location_id" uuid not null,
    "export_type" text not null,
    "status" text not null default 'pending'::text,
    "progress" integer default 0,
    "total_placemarks" integer,
    "processed_placemarks" integer default 0,
    "file_url" text,
    "file_size_bytes" bigint,
    "error_message" text,
    "created_at" timestamp with time zone default now(),
    "started_at" timestamp with time zone,
    "completed_at" timestamp with time zone,
    "visit_id" bigint not null
      );


alter table "public"."export_jobs" enable row level security;


  create table "public"."hotspot_attachments" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "hotspot_id" bigint not null,
    "filename" text not null,
    "url" text not null,
    "attachment_type" text default 'image'::text,
    "deleted_at" timestamp with time zone
      );


alter table "public"."hotspot_attachments" enable row level security;


  create table "public"."hotspots" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "panorama_id" uuid not null,
    "yaw" double precision not null,
    "pitch" double precision not null,
    "title" text not null,
    "description" text,
    "deleted_at" timestamp with time zone
      );


alter table "public"."hotspots" enable row level security;


  create table "public"."panoramas" (
    "id" uuid not null default extensions.uuid_generate_v4(),
    "filename" text not null,
    "address" text,
    "url" text not null,
    "thumbnail" text not null,
    "latitude" double precision not null,
    "longitude" double precision not null,
    "created_at" timestamp with time zone default now(),
    "horizon_pitch" real not null default '0'::real,
    "horizon_roll" real not null default '0'::real,
    "deleted_at" timestamp with time zone,
    "visit_id" bigint not null
      );


alter table "public"."panoramas" enable row level security;


  create table "public"."placemark_data_schemas" (
    "id" uuid not null default extensions.uuid_generate_v4(),
    "company_id" uuid not null,
    "name" text not null,
    "description" text,
    "schema" jsonb not null,
    "is_default" boolean default false,
    "created_at" timestamp with time zone default now()
      );


alter table "public"."placemark_data_schemas" enable row level security;


  create table "public"."placemark_history" (
    "id" bigint not null default nextval('public.placemark_history_id_seq'::regclass),
    "placemark_id" bigint not null,
    "changed_by" uuid,
    "changed_at" timestamp with time zone not null default now(),
    "action" text not null,
    "changed_fields" text[],
    "custom_data_snapshot" jsonb,
    "visit_id" bigint,
    "image_id" uuid,
    "notes" text
      );


alter table "public"."placemark_history" enable row level security;


  create table "public"."placemark_image_schema" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "schema" jsonb not null,
    "name" text,
    "company_id" uuid
      );


alter table "public"."placemark_image_schema" enable row level security;


  create table "public"."placemark_images" (
    "id" uuid not null default extensions.uuid_generate_v4(),
    "placemark_id" bigint not null,
    "filename" text not null,
    "url" text not null,
    "thumbnail_url" text,
    "caption" text,
    "metadata" jsonb default '{}'::jsonb,
    "created_at" timestamp with time zone default now(),
    "title" text,
    "uploaded_by" uuid,
    "deleted_at" timestamp with time zone,
    "variance" real,
    "visit_record_id" bigint not null
      );


alter table "public"."placemark_images" enable row level security;


  create table "public"."placemarks" (
    "id" bigint not null default nextval('public.placemarks_id_seq'::regclass),
    "external_id" text not null,
    "latitude" real not null,
    "longitude" real not null,
    "address" text,
    "type" text,
    "company_id" uuid not null,
    "created_at" timestamp with time zone not null default now(),
    "deleted_at" timestamp with time zone
      );


alter table "public"."placemarks" enable row level security;


  create table "public"."projects" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "company_id" uuid not null,
    "name" text,
    "deleted_at" timestamp with time zone,
    "scheduler_active_until" timestamp with time zone,
    "scheduler_enabled" boolean not null default false,
    "scheduler_report_emails" text[],
    "scheduler_report_hour" integer not null default 20,
    "scheduler_report_minute" integer not null default 0
      );


alter table "public"."projects" enable row level security;


  create table "public"."reports" (
    "id" bigint generated by default as identity not null,
    "project_id" bigint not null,
    "company_id" uuid not null,
    "type" text not null,
    "data" jsonb not null default '{}'::jsonb,
    "created_at" timestamp with time zone not null default now()
      );


alter table "public"."reports" enable row level security;


  create table "public"."site_data" (
    "id" bigint generated by default as identity not null,
    "site_id" bigint not null,
    "company_id" uuid not null,
    "name" text,
    "created_at" timestamp with time zone not null default now()
      );


alter table "public"."site_data" enable row level security;


  create table "public"."site_elements" (
    "id" bigint not null default nextval('public.site_elements_id_seq'::regclass),
    "external_id" text,
    "company_id" uuid not null,
    "site_id" bigint not null,
    "element_name" text not null,
    "element_type" text not null,
    "created_at" timestamp with time zone not null default now()
      );



  create table "public"."sites" (
    "id" bigint generated by default as identity not null,
    "address" text,
    "latitude" real not null,
    "longitude" real not null,
    "created_at" timestamp with time zone not null default now()
      );


alter table "public"."sites" enable row level security;


  create table "public"."user_companies" (
    "id" uuid not null default extensions.uuid_generate_v4(),
    "user_id" uuid,
    "company_id" uuid not null,
    "created_at" timestamp with time zone default now()
      );


alter table "public"."user_companies" enable row level security;


  create table "public"."user_roles" (
    "id" bigint generated by default as identity not null,
    "created_at" timestamp with time zone not null default now(),
    "user_id" uuid,
    "role" text not null
      );


alter table "public"."user_roles" enable row level security;


  create table "public"."visit_records" (
    "id" bigint not null default nextval('public.visit_records_id_seq'::regclass),
    "visit_id" bigint not null,
    "placemark_id" bigint not null,
    "custom_data" jsonb,
    "approval_status" text,
    "visited_at" timestamp with time zone,
    "assigned_to" uuid,
    "sequence_order" smallint,
    "created_at" timestamp with time zone not null default now(),
    "deleted_at" timestamp with time zone
      );


alter table "public"."visit_records" enable row level security;


  create table "public"."visits" (
    "id" bigint not null default nextval('public.visits_id_seq'::regclass),
    "name" text not null,
    "description" text,
    "created_at" timestamp with time zone default now(),
    "data_schema_id" uuid,
    "image_schema_id" bigint,
    "project_id" bigint,
    "deleted_at" timestamp with time zone
      );


alter table "public"."visits" enable row level security;

alter sequence "public"."placemark_history_id_seq" owned by "public"."placemark_history"."id";

alter sequence "public"."placemarks_id_seq" owned by "public"."placemarks"."id";

alter sequence "public"."site_elements_id_seq" owned by "public"."site_elements"."id";

alter sequence "public"."visit_records_id_seq" owned by "public"."visit_records"."id";

alter sequence "public"."visits_id_seq" owned by "public"."visits"."id";

CREATE UNIQUE INDEX "QGIS_geometry_key" ON public."QGIS" USING btree (geometry);

CREATE UNIQUE INDEX "QGIS_pkey" ON public."QGIS" USING btree (id);

CREATE UNIQUE INDEX _migration_hotspot_mapping_pkey ON public._migration_hotspot_mapping USING btree (panorama_id, old_hotspot_uuid, array_position);

CREATE UNIQUE INDEX _migration_location_to_visit_pkey ON public._migration_location_to_visit USING btree (old_location_id);

CREATE UNIQUE INDEX _migration_placemark_mapping_pkey ON public._migration_placemark_mapping USING btree (old_placemark_id);

CREATE UNIQUE INDEX companies_pkey ON public.companies USING btree (id);

CREATE UNIQUE INDEX embeddings_pkey ON public.clip_embeddings USING btree (id);

CREATE UNIQUE INDEX export_jobs_pkey ON public.export_jobs USING btree (id);

CREATE UNIQUE INDEX hotspot_attachments_pkey ON public.hotspot_attachments USING btree (id);

CREATE UNIQUE INDEX hotspots_pkey ON public.hotspots USING btree (id);

CREATE INDEX idx_clip_embeddings_placemark_image_id ON public.clip_embeddings USING btree (placemark_image_id);

CREATE INDEX idx_embeddings_l2 ON public.clip_embeddings USING ivfflat (embeddings) WITH (lists='100');

CREATE INDEX idx_export_jobs_created_at ON public.export_jobs USING btree (created_at DESC);

CREATE INDEX idx_export_jobs_location_id ON public.export_jobs USING btree (location_id);

CREATE INDEX idx_export_jobs_status ON public.export_jobs USING btree (status);

CREATE INDEX idx_export_jobs_user_id ON public.export_jobs USING btree (user_id);

CREATE INDEX idx_export_jobs_visit_id ON public.export_jobs USING btree (visit_id);

CREATE INDEX idx_hotspot_attachments_hotspot_id ON public.hotspot_attachments USING btree (hotspot_id);

CREATE INDEX idx_hotspots_panorama_id ON public.hotspots USING btree (panorama_id);

CREATE INDEX idx_panoramas_visit_id ON public.panoramas USING btree (visit_id) WHERE (deleted_at IS NULL);

CREATE INDEX idx_placemark_data_schemas_company_id ON public.placemark_data_schemas USING btree (company_id);

CREATE INDEX idx_placemark_history_changed_at ON public.placemark_history USING btree (changed_at DESC);

CREATE INDEX idx_placemark_history_changed_by ON public.placemark_history USING btree (changed_by);

CREATE INDEX idx_placemark_history_image_id ON public.placemark_history USING btree (image_id);

CREATE INDEX idx_placemark_history_placemark_id ON public.placemark_history USING btree (placemark_id);

CREATE INDEX idx_placemark_history_visit_id ON public.placemark_history USING btree (visit_id);

CREATE INDEX idx_placemark_image_schema_company_id ON public.placemark_image_schema USING btree (company_id);

CREATE INDEX idx_placemark_images_placemark_id ON public.placemark_images USING btree (placemark_id);

CREATE INDEX idx_placemark_images_uploaded_by ON public.placemark_images USING btree (uploaded_by);

CREATE INDEX idx_placemark_images_visit_record_id ON public.placemark_images USING btree (visit_record_id);

CREATE INDEX idx_placemarks_company_id ON public.placemarks USING btree (company_id) WHERE (deleted_at IS NULL);

CREATE INDEX idx_projects_company_id ON public.projects USING btree (company_id);

CREATE INDEX idx_projects_scheduler_enabled ON public.projects USING btree (scheduler_enabled) WHERE ((scheduler_enabled = true) AND (deleted_at IS NULL));

CREATE INDEX idx_qgis_geometry_gist ON public."QGIS" USING gist (geometry);

CREATE INDEX idx_reports_company_id ON public.reports USING btree (company_id);

CREATE INDEX idx_reports_created_at ON public.reports USING btree (created_at DESC);

CREATE INDEX idx_reports_project_id ON public.reports USING btree (project_id);

CREATE INDEX idx_reports_project_type ON public.reports USING btree (project_id, type);

CREATE INDEX idx_reports_type ON public.reports USING btree (type);

CREATE INDEX idx_site_elements_company_id ON public.site_elements USING btree (company_id);

CREATE INDEX idx_site_elements_site_id ON public.site_elements USING btree (site_id);

CREATE INDEX idx_user_companies_company_id ON public.user_companies USING btree (company_id);

CREATE INDEX idx_user_companies_user_company ON public.user_companies USING btree (user_id, company_id);

CREATE INDEX idx_user_companies_user_id ON public.user_companies USING btree (user_id);

CREATE INDEX idx_user_roles_user_id ON public.user_roles USING btree (user_id);

CREATE INDEX idx_visit_records_assigned_to ON public.visit_records USING btree (assigned_to);

CREATE INDEX idx_visit_records_placemark_id ON public.visit_records USING btree (placemark_id);

CREATE INDEX idx_visit_records_visit_id ON public.visit_records USING btree (visit_id);

CREATE INDEX idx_visits_data_schema_id ON public.visits USING btree (data_schema_id);

CREATE INDEX idx_visits_image_schema_id ON public.visits USING btree (image_schema_id);

CREATE INDEX idx_visits_project_id ON public.visits USING btree (project_id) WHERE (deleted_at IS NULL);

CREATE UNIQUE INDEX panoramas_pkey ON public.panoramas USING btree (id);

CREATE UNIQUE INDEX placemark_data_schemas_pkey ON public.placemark_data_schemas USING btree (id);

CREATE UNIQUE INDEX placemark_history_pkey ON public.placemark_history USING btree (id);

CREATE UNIQUE INDEX placemark_images_pkey ON public.placemark_images USING btree (id);

CREATE UNIQUE INDEX placemark_photo_category_schemas_pkey ON public.placemark_image_schema USING btree (id);

CREATE UNIQUE INDEX placemarks_pkey ON public.placemarks USING btree (id);

CREATE UNIQUE INDEX projects_pkey ON public.projects USING btree (id);

CREATE UNIQUE INDEX reports_pkey ON public.reports USING btree (id);

CREATE UNIQUE INDEX site_data_pkey ON public.site_data USING btree (id);

CREATE UNIQUE INDEX site_elements_pkey ON public.site_elements USING btree (id);

CREATE UNIQUE INDEX sites_pkey ON public.sites USING btree (id);

CREATE UNIQUE INDEX user_companies_pkey ON public.user_companies USING btree (id);

CREATE UNIQUE INDEX user_roles_pkey ON public.user_roles USING btree (id);

CREATE UNIQUE INDEX user_roles_user_id_key ON public.user_roles USING btree (user_id);

CREATE UNIQUE INDEX visit_records_pkey ON public.visit_records USING btree (id);

CREATE UNIQUE INDEX visits_pkey ON public.visits USING btree (id);

alter table "public"."QGIS" add constraint "QGIS_pkey" PRIMARY KEY using index "QGIS_pkey";

alter table "public"."_migration_hotspot_mapping" add constraint "_migration_hotspot_mapping_pkey" PRIMARY KEY using index "_migration_hotspot_mapping_pkey";

alter table "public"."_migration_location_to_visit" add constraint "_migration_location_to_visit_pkey" PRIMARY KEY using index "_migration_location_to_visit_pkey";

alter table "public"."_migration_placemark_mapping" add constraint "_migration_placemark_mapping_pkey" PRIMARY KEY using index "_migration_placemark_mapping_pkey";

alter table "public"."clip_embeddings" add constraint "embeddings_pkey" PRIMARY KEY using index "embeddings_pkey";

alter table "public"."companies" add constraint "companies_pkey" PRIMARY KEY using index "companies_pkey";

alter table "public"."export_jobs" add constraint "export_jobs_pkey" PRIMARY KEY using index "export_jobs_pkey";

alter table "public"."hotspot_attachments" add constraint "hotspot_attachments_pkey" PRIMARY KEY using index "hotspot_attachments_pkey";

alter table "public"."hotspots" add constraint "hotspots_pkey" PRIMARY KEY using index "hotspots_pkey";

alter table "public"."panoramas" add constraint "panoramas_pkey" PRIMARY KEY using index "panoramas_pkey";

alter table "public"."placemark_data_schemas" add constraint "placemark_data_schemas_pkey" PRIMARY KEY using index "placemark_data_schemas_pkey";

alter table "public"."placemark_history" add constraint "placemark_history_pkey" PRIMARY KEY using index "placemark_history_pkey";

alter table "public"."placemark_image_schema" add constraint "placemark_photo_category_schemas_pkey" PRIMARY KEY using index "placemark_photo_category_schemas_pkey";

alter table "public"."placemark_images" add constraint "placemark_images_pkey" PRIMARY KEY using index "placemark_images_pkey";

alter table "public"."placemarks" add constraint "placemarks_pkey" PRIMARY KEY using index "placemarks_pkey";

alter table "public"."projects" add constraint "projects_pkey" PRIMARY KEY using index "projects_pkey";

alter table "public"."reports" add constraint "reports_pkey" PRIMARY KEY using index "reports_pkey";

alter table "public"."site_data" add constraint "site_data_pkey" PRIMARY KEY using index "site_data_pkey";

alter table "public"."site_elements" add constraint "site_elements_pkey" PRIMARY KEY using index "site_elements_pkey";

alter table "public"."sites" add constraint "sites_pkey" PRIMARY KEY using index "sites_pkey";

alter table "public"."user_companies" add constraint "user_companies_pkey" PRIMARY KEY using index "user_companies_pkey";

alter table "public"."user_roles" add constraint "user_roles_pkey" PRIMARY KEY using index "user_roles_pkey";

alter table "public"."visit_records" add constraint "visit_records_pkey" PRIMARY KEY using index "visit_records_pkey";

alter table "public"."visits" add constraint "visits_pkey" PRIMARY KEY using index "visits_pkey";

alter table "public"."QGIS" add constraint "QGIS_created_by_fkey" FOREIGN KEY (created_by) REFERENCES auth.users(id) ON UPDATE CASCADE not valid;

alter table "public"."QGIS" validate constraint "QGIS_created_by_fkey";

alter table "public"."QGIS" add constraint "QGIS_geometry_key" UNIQUE using index "QGIS_geometry_key";

alter table "public"."clip_embeddings" add constraint "embeddings_placemark_image_id_fkey" FOREIGN KEY (placemark_image_id) REFERENCES public.placemark_images(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."clip_embeddings" validate constraint "embeddings_placemark_image_id_fkey";

alter table "public"."export_jobs" add constraint "export_jobs_export_type_check" CHECK ((export_type = ANY (ARRAY['excel'::text, 'kml'::text, 'pdf'::text]))) not valid;

alter table "public"."export_jobs" validate constraint "export_jobs_export_type_check";

alter table "public"."export_jobs" add constraint "export_jobs_progress_check" CHECK (((progress >= 0) AND (progress <= 100))) not valid;

alter table "public"."export_jobs" validate constraint "export_jobs_progress_check";

alter table "public"."export_jobs" add constraint "export_jobs_status_check" CHECK ((status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'failed'::text]))) not valid;

alter table "public"."export_jobs" validate constraint "export_jobs_status_check";

alter table "public"."export_jobs" add constraint "export_jobs_user_id_fkey" FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE SET NULL not valid;

alter table "public"."export_jobs" validate constraint "export_jobs_user_id_fkey";

alter table "public"."export_jobs" add constraint "export_jobs_visit_id_fkey" FOREIGN KEY (visit_id) REFERENCES public.visits(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."export_jobs" validate constraint "export_jobs_visit_id_fkey";

alter table "public"."export_jobs" add constraint "valid_dates" CHECK (((started_at >= created_at) AND ((completed_at IS NULL) OR (completed_at >= started_at)))) not valid;

alter table "public"."export_jobs" validate constraint "valid_dates";

alter table "public"."hotspot_attachments" add constraint "hotspot_attachments_attachment_type_check" CHECK ((attachment_type = ANY (ARRAY['image'::text, 'view_capture'::text]))) not valid;

alter table "public"."hotspot_attachments" validate constraint "hotspot_attachments_attachment_type_check";

alter table "public"."hotspot_attachments" add constraint "hotspot_attachments_hotspot_id_fkey" FOREIGN KEY (hotspot_id) REFERENCES public.hotspots(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."hotspot_attachments" validate constraint "hotspot_attachments_hotspot_id_fkey";

alter table "public"."hotspots" add constraint "hotspots_panorama_id_fkey" FOREIGN KEY (panorama_id) REFERENCES public.panoramas(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."hotspots" validate constraint "hotspots_panorama_id_fkey";

alter table "public"."panoramas" add constraint "panoramas_visit_id_fkey" FOREIGN KEY (visit_id) REFERENCES public.visits(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."panoramas" validate constraint "panoramas_visit_id_fkey";

alter table "public"."placemark_data_schemas" add constraint "placemark_data_schemas_company_id_fkey" FOREIGN KEY (company_id) REFERENCES public.companies(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."placemark_data_schemas" validate constraint "placemark_data_schemas_company_id_fkey";

alter table "public"."placemark_history" add constraint "placemark_history_action_check" CHECK ((action = ANY (ARRAY['PLACEMARK_CREATE'::text, 'PLACEMARK_UPDATE'::text, 'PLACEMARK_DELETE'::text, 'VISIT_ASSIGNED'::text, 'VISIT_UNASSIGNED'::text, 'CUSTOM_DATA_UPDATE'::text, 'IMAGE_CREATE'::text, 'IMAGE_UPDATE'::text, 'IMAGE_DELETE'::text]))) not valid;

alter table "public"."placemark_history" validate constraint "placemark_history_action_check";

alter table "public"."placemark_history" add constraint "placemark_history_changed_by_fkey" FOREIGN KEY (changed_by) REFERENCES auth.users(id) ON DELETE SET NULL not valid;

alter table "public"."placemark_history" validate constraint "placemark_history_changed_by_fkey";

alter table "public"."placemark_history" add constraint "placemark_history_image_id_fkey" FOREIGN KEY (image_id) REFERENCES public.placemark_images(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."placemark_history" validate constraint "placemark_history_image_id_fkey";

alter table "public"."placemark_history" add constraint "placemark_history_placemark_id_fkey" FOREIGN KEY (placemark_id) REFERENCES public.placemarks(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."placemark_history" validate constraint "placemark_history_placemark_id_fkey";

alter table "public"."placemark_history" add constraint "placemark_history_visit_id_fkey" FOREIGN KEY (visit_id) REFERENCES public.visits(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."placemark_history" validate constraint "placemark_history_visit_id_fkey";

alter table "public"."placemark_image_schema" add constraint "placemark_photo_category_schemas_company_id_fkey" FOREIGN KEY (company_id) REFERENCES public.companies(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."placemark_image_schema" validate constraint "placemark_photo_category_schemas_company_id_fkey";

alter table "public"."placemark_images" add constraint "placemark_images_placemark_id_fkey" FOREIGN KEY (placemark_id) REFERENCES public.placemarks(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."placemark_images" validate constraint "placemark_images_placemark_id_fkey";

alter table "public"."placemark_images" add constraint "placemark_images_uploaded_by_fkey" FOREIGN KEY (uploaded_by) REFERENCES auth.users(id) ON UPDATE CASCADE ON DELETE SET NULL not valid;

alter table "public"."placemark_images" validate constraint "placemark_images_uploaded_by_fkey";

alter table "public"."placemark_images" add constraint "placemark_images_visit_record_id_fkey" FOREIGN KEY (visit_record_id) REFERENCES public.visit_records(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."placemark_images" validate constraint "placemark_images_visit_record_id_fkey";

alter table "public"."placemarks" add constraint "placemarks_company_id_fkey" FOREIGN KEY (company_id) REFERENCES public.companies(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."placemarks" validate constraint "placemarks_company_id_fkey";

alter table "public"."projects" add constraint "projects_company_id_fkey" FOREIGN KEY (company_id) REFERENCES public.companies(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."projects" validate constraint "projects_company_id_fkey";

alter table "public"."projects" add constraint "projects_scheduler_report_hour_check" CHECK (((scheduler_report_hour >= 0) AND (scheduler_report_hour <= 23))) not valid;

alter table "public"."projects" validate constraint "projects_scheduler_report_hour_check";

alter table "public"."projects" add constraint "projects_scheduler_report_minute_check" CHECK (((scheduler_report_minute >= 0) AND (scheduler_report_minute <= 59))) not valid;

alter table "public"."projects" validate constraint "projects_scheduler_report_minute_check";

alter table "public"."reports" add constraint "reports_company_id_fkey" FOREIGN KEY (company_id) REFERENCES public.companies(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."reports" validate constraint "reports_company_id_fkey";

alter table "public"."reports" add constraint "reports_project_id_fkey" FOREIGN KEY (project_id) REFERENCES public.projects(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."reports" validate constraint "reports_project_id_fkey";

alter table "public"."reports" add constraint "reports_type_check" CHECK ((type = ANY (ARRAY['daily'::text, 'overall'::text]))) not valid;

alter table "public"."reports" validate constraint "reports_type_check";

alter table "public"."site_data" add constraint "site_data_company_id_fkey" FOREIGN KEY (company_id) REFERENCES public.companies(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."site_data" validate constraint "site_data_company_id_fkey";

alter table "public"."site_data" add constraint "site_data_site_id_fkey" FOREIGN KEY (site_id) REFERENCES public.sites(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."site_data" validate constraint "site_data_site_id_fkey";

alter table "public"."site_elements" add constraint "site_elements_company_id_fkey" FOREIGN KEY (company_id) REFERENCES public.companies(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."site_elements" validate constraint "site_elements_company_id_fkey";

alter table "public"."site_elements" add constraint "site_elements_site_id_fkey" FOREIGN KEY (site_id) REFERENCES public.site_data(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."site_elements" validate constraint "site_elements_site_id_fkey";

alter table "public"."user_companies" add constraint "user_companies_company_id_fkey" FOREIGN KEY (company_id) REFERENCES public.companies(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."user_companies" validate constraint "user_companies_company_id_fkey";

alter table "public"."user_companies" add constraint "user_companies_user_id_fkey" FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE SET NULL not valid;

alter table "public"."user_companies" validate constraint "user_companies_user_id_fkey";

alter table "public"."user_roles" add constraint "user_roles_role_check" CHECK ((role = ANY (ARRAY['ADMIN'::text, 'PM'::text, 'CLIENT'::text, 'SUBCONTRACTOR'::text, 'CONTRACTOR'::text, 'FIELD'::text, 'QGIS'::text]))) not valid;

alter table "public"."user_roles" validate constraint "user_roles_role_check";

alter table "public"."user_roles" add constraint "user_roles_user_id_fkey" FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE SET NULL not valid;

alter table "public"."user_roles" validate constraint "user_roles_user_id_fkey";

alter table "public"."user_roles" add constraint "user_roles_user_id_key" UNIQUE using index "user_roles_user_id_key";

alter table "public"."visit_records" add constraint "visit_records_placemark_id_fkey" FOREIGN KEY (placemark_id) REFERENCES public.placemarks(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."visit_records" validate constraint "visit_records_placemark_id_fkey";

alter table "public"."visit_records" add constraint "visit_records_visit_id_fkey" FOREIGN KEY (visit_id) REFERENCES public.visits(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."visit_records" validate constraint "visit_records_visit_id_fkey";

alter table "public"."visit_records" add constraint "visit_routes_assigned_to_fkey" FOREIGN KEY (assigned_to) REFERENCES auth.users(id) ON DELETE SET NULL not valid;

alter table "public"."visit_records" validate constraint "visit_routes_assigned_to_fkey";

alter table "public"."visits" add constraint "visits_data_schema_id_fkey" FOREIGN KEY (data_schema_id) REFERENCES public.placemark_data_schemas(id) ON UPDATE CASCADE not valid;

alter table "public"."visits" validate constraint "visits_data_schema_id_fkey";

alter table "public"."visits" add constraint "visits_image_schema_id_fkey" FOREIGN KEY (image_schema_id) REFERENCES public.placemark_image_schema(id) ON UPDATE CASCADE not valid;

alter table "public"."visits" validate constraint "visits_image_schema_id_fkey";

alter table "public"."visits" add constraint "visits_project_id_fkey" FOREIGN KEY (project_id) REFERENCES public.projects(id) ON UPDATE CASCADE ON DELETE CASCADE not valid;

alter table "public"."visits" validate constraint "visits_project_id_fkey";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.delete_user_by_id(target_user_id uuid)
 RETURNS void
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
  BEGIN
    -- Delete from user_roles
    DELETE FROM user_roles WHERE user_id = target_user_id;

    -- Delete from user_companies
    DELETE FROM user_companies WHERE user_id = target_user_id;

    -- Soft delete from auth.users (set deleted_at)
    UPDATE auth.users
    SET deleted_at = NOW()
    WHERE id = target_user_id;

  EXCEPTION
    WHEN OTHERS THEN
      RAISE EXCEPTION 'Error deleting user: %', SQLERRM;
  END;
  $function$
;

CREATE OR REPLACE FUNCTION public.find_similar_titled_image(query_image_id uuid, query_embedding extensions.vector)
 RETURNS TABLE(id uuid, title text, distance double precision)
 LANGUAGE sql
 STABLE
 SET search_path TO 'public', 'extensions', 'auth'
AS $function$
      SELECT
          pi.id,
          pi.title,
          ce.embeddings <=> query_embedding AS distance
      FROM placemark_images pi
      INNER JOIN clip_embeddings ce ON ce.placemark_image_id = pi.id
      WHERE pi.title IS NOT NULL
          AND pi.deleted_at IS NULL
          AND pi.id != query_image_id
      ORDER BY ce.embeddings <=> query_embedding
      LIMIT 1;
  $function$
;

CREATE OR REPLACE FUNCTION public.get_all_users_with_details()
 RETURNS TABLE(id uuid, email text, created_at timestamp with time zone, invited_at timestamp with time zone, email_confirmed_at timestamp with time zone, role text, companies jsonb)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
BEGIN
  RETURN QUERY
  SELECT
    u.id,
    u.email::text,
    u.created_at,
    u.invited_at,
    u.email_confirmed_at,
    ur.role::text,
    COALESCE(
      jsonb_agg(
        jsonb_build_object('id', c.id, 'name', c.name)
      ) FILTER (WHERE c.id IS NOT NULL),
      '[]'::jsonb
    ) as companies
  FROM auth.users u
  LEFT JOIN user_roles ur ON ur.user_id = u.id
  LEFT JOIN user_companies uc ON uc.user_id = u.id
  LEFT JOIN companies c ON c.id = uc.company_id
  WHERE u.deleted_at IS NULL
  GROUP BY u.id, u.email, u.created_at, u.invited_at, u.email_confirmed_at, ur.role
  ORDER BY u.created_at DESC;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_daily_technician_summary(p_visit_id bigint, p_day date DEFAULT CURRENT_DATE)
 RETURNS TABLE(technician_id uuid, elements_visited bigint, total_images bigint, first_visit_time timestamp with time zone, last_visit_time timestamp with time zone)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        pi.uploaded_by as technician_id,
        COUNT(DISTINCT pi.visit_record_id) as elements_visited,
        COUNT(*) as total_images,
        MIN(pi.created_at) as first_visit_time,
        MAX(pi.created_at) as last_visit_time
    FROM placemark_images pi
    INNER JOIN visit_records vr ON pi.visit_record_id = vr.id
    WHERE vr.visit_id = p_visit_id
        AND pi.deleted_at IS NULL
        AND DATE(pi.created_at) = p_day
    GROUP BY pi.uploaded_by
    ORDER BY elements_visited DESC;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_daily_technician_visits(p_visit_id bigint, p_day date DEFAULT CURRENT_DATE)
 RETURNS TABLE(technician_id uuid, placemark_id bigint, external_id text, first_visit_time timestamp with time zone, image_count bigint, visit_record_id bigint)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    WITH earliest_images AS (
        SELECT 
            pi.visit_record_id,
            pi.placemark_id,
            pi.uploaded_by as technician_id,
            MIN(pi.created_at) as first_image_time,
            COUNT(*) as img_count
        FROM placemark_images pi
        INNER JOIN visit_records vr ON pi.visit_record_id = vr.id
        WHERE vr.visit_id = p_visit_id
            AND pi.deleted_at IS NULL
            AND DATE(pi.created_at) = p_day
        GROUP BY pi.visit_record_id, pi.placemark_id, pi.uploaded_by
    )
    SELECT 
        ei.technician_id,
        ei.placemark_id,
        p.external_id,
        ei.first_image_time,
        ei.img_count,
        ei.visit_record_id
    FROM earliest_images ei
    INNER JOIN placemarks p ON ei.placemark_id = p.id
    ORDER BY ei.technician_id, ei.first_image_time;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_geometries_in_extent(x_min double precision, x_max double precision, y_min double precision, y_max double precision, srid integer, user_id uuid)
 RETURNS TABLE(id bigint, geometry jsonb, created_at timestamp with time zone, created_by uuid)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
    RETURN QUERY
    SELECT
        q.id,
        ST_AsGeoJSON(q.geometry)::jsonb as geometry,
        q.created_at,
        q.created_by
    FROM public."QGIS" q
    WHERE q.created_by = user_id
    AND ST_Intersects(
        q.geometry,
        ST_MakeEnvelope(x_min, y_min, x_max, y_max, srid)
    );
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_image_audit_with_user(p_image_ids uuid[], p_limit integer DEFAULT 50)
 RETURNS TABLE(id bigint, image_id uuid, changed_by uuid, changed_at timestamp with time zone, action text, changed_fields text[], notes text, user_email character varying)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
BEGIN
  RETURN QUERY
  SELECT
    ph.id,
    ph.image_id,
    ph.changed_by,
    ph.changed_at,
    ph.action,
    ph.changed_fields,
    ph.notes,
    COALESCE(u.email, 'Unknown')::VARCHAR as user_email
  FROM placemark_history ph
  LEFT JOIN auth.users u ON u.id = ph.changed_by
  WHERE ph.image_id = ANY(p_image_ids)
    AND ph.action IN ('IMAGE_CREATE', 'IMAGE_UPDATE', 'IMAGE_DELETE')
  ORDER BY ph.changed_at DESC
  LIMIT p_limit;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_latest_placemark_modifications(p_visit_id bigint)
 RETURNS TABLE(id bigint, placemark_id bigint, changed_by uuid, changed_at timestamp with time zone, action text, changed_fields text[], custom_data_snapshot jsonb, visit_id bigint, image_id uuid, notes text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT ON (ph.placemark_id) 
        ph.id,
        ph.placemark_id,
        ph.changed_by,
        ph.changed_at,
        ph.action,
        ph.changed_fields,
        ph.custom_data_snapshot,
        ph.visit_id,
        ph.image_id,
        ph.notes
    FROM placemark_history ph
    WHERE ph.visit_id = p_visit_id 
        AND ph.action = 'CUSTOM_DATA_UPDATE'
    ORDER BY ph.placemark_id, ph.changed_at DESC;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_latest_placemark_modifications(p_visit_id bigint, p_day date DEFAULT NULL::date)
 RETURNS TABLE(id bigint, placemark_id bigint, changed_by uuid, changed_at timestamp with time zone, action text, changed_fields text[], custom_data_snapshot jsonb, visit_id bigint, image_id uuid, notes text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT DISTINCT ON (ph.placemark_id) 
        ph.id,
        ph.placemark_id,
        ph.changed_by,
        ph.changed_at,
        ph.action,
        ph.changed_fields,
        ph.custom_data_snapshot,
        ph.visit_id,
        ph.image_id,
        ph.notes
    FROM placemark_history ph
    WHERE ph.visit_id = p_visit_id 
        AND ph.action = 'CUSTOM_DATA_UPDATE'
        AND (p_day IS NULL OR DATE(ph.changed_at) = p_day)
    ORDER BY ph.placemark_id, ph.changed_at DESC;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_placemark_audit_with_user(p_placemark_id bigint, p_limit integer DEFAULT 50)
 RETURNS TABLE(id bigint, placemark_id bigint, changed_by uuid, changed_at timestamp with time zone, action text, changed_fields text[], custom_data_snapshot jsonb, notes text, user_email character varying)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
BEGIN
  RETURN QUERY
  SELECT
    ph.id,
    ph.placemark_id,
    ph.changed_by,
    ph.changed_at,
    ph.action,
    ph.changed_fields,
    ph.custom_data_snapshot,
    ph.notes,
    COALESCE(u.email, 'Unknown')::VARCHAR as user_email
  FROM placemark_history ph
  LEFT JOIN auth.users u ON u.id = ph.changed_by
  WHERE ph.placemark_id = p_placemark_id
    AND ph.action IN ('PLACEMARK_CREATE', 'PLACEMARK_UPDATE', 'PLACEMARK_DELETE', 'CUSTOM_DATA_UPDATE')
  ORDER BY ph.changed_at DESC
  LIMIT p_limit;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_placemark_history_with_user(p_placemark_id bigint, p_limit integer DEFAULT 100)
 RETURNS TABLE(id bigint, placemark_id bigint, changed_by uuid, changed_at timestamp with time zone, action text, changed_fields text[], custom_data_snapshot jsonb, visit_id bigint, image_id uuid, notes text, user_email character varying)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
BEGIN
  RETURN QUERY
  SELECT
    ph.id,
    ph.placemark_id,
    ph.changed_by,
    ph.changed_at,
    ph.action,
    ph.changed_fields,
    ph.custom_data_snapshot,
    -- Derive visit_id: use ph.visit_id if present, otherwise get from visit_records via image
    COALESCE(ph.visit_id, vr.visit_id) AS visit_id,
    ph.image_id,
    ph.notes,
    COALESCE(u.email, 'Unknown')::varchar AS user_email
  FROM placemark_history ph
  LEFT JOIN auth.users u ON u.id = ph.changed_by
  LEFT JOIN placemark_images pi ON ph.image_id = pi.id
  LEFT JOIN visit_records vr ON pi.visit_record_id = vr.id
  WHERE ph.placemark_id = p_placemark_id
  ORDER BY ph.changed_at DESC
  LIMIT p_limit;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_users_by_company_and_role(target_company_id uuid, target_role text)
 RETURNS TABLE(id uuid, email text, created_at timestamp with time zone, role text)
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
BEGIN
  RETURN QUERY
  SELECT
    u.id,
    u.email::text,
    u.created_at,
    ur.role::text
  FROM auth.users u
  INNER JOIN user_roles ur ON ur.user_id = u.id
  INNER JOIN user_companies uc ON uc.user_id = u.id
  WHERE
    u.deleted_at IS NULL
    AND ur.role = target_role
    AND uc.company_id = target_company_id
  ORDER BY u.email;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.insert_geometry(geom_json jsonb, user_id uuid)
 RETURNS jsonb
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
  DECLARE
      result_id bigint;
      geom_wkt geometry;
  BEGIN
      -- Convert GeoJSON to PostGIS geometry with SRID 4326
      geom_wkt := ST_SetSRID(ST_GeomFromGeoJSON(geom_json::text), 4326);

      -- Insert with ON CONFLICT to handle duplicates
      INSERT INTO public."QGIS" (geometry, created_by)
      VALUES (geom_wkt, user_id)
      ON CONFLICT (geometry) DO NOTHING
      RETURNING id INTO result_id;

      -- If result_id is NULL, it means the geometry already existed (duplicate)
      IF result_id IS NULL THEN
          RETURN jsonb_build_object(
              'success', true,
              'duplicate', true,
              'message', 'Geometry already exists'
          );
      ELSE
          RETURN jsonb_build_object(
              'success', true,
              'duplicate', false,
              'id', result_id
          );
      END IF;

  EXCEPTION
      WHEN OTHERS THEN
          RETURN jsonb_build_object(
              'success', false,
              'error', SQLERRM,
              'error_code', SQLSTATE
          );
  END;
  $function$
;

CREATE OR REPLACE FUNCTION public.is_admin()
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
  SELECT EXISTS (
    SELECT 1
    FROM public.user_roles
    WHERE user_id = auth.uid()
    AND role = 'ADMIN'
  )
$function$
;

CREATE OR REPLACE FUNCTION public.user_company_ids()
 RETURNS uuid[]
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
  SELECT ARRAY_AGG(company_id)
  FROM public.user_companies
  WHERE user_id = auth.uid()
$function$
;

CREATE OR REPLACE FUNCTION public.user_has_role(allowed_roles text[])
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
  SELECT EXISTS (
    SELECT 1
    FROM public.user_roles
    WHERE user_id = auth.uid()
    AND role = ANY(allowed_roles)
  )
$function$
;

CREATE OR REPLACE FUNCTION public.user_in_company(target_company_id uuid)
 RETURNS boolean
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
  SELECT EXISTS (
    SELECT 1
    FROM public.user_companies
    WHERE user_id = auth.uid()
    AND company_id = target_company_id
  )
$function$
;

CREATE OR REPLACE FUNCTION public.user_role()
 RETURNS text
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public', 'auth'
AS $function$
  SELECT role
  FROM public.user_roles
  WHERE user_id = auth.uid()
  LIMIT 1
$function$
;

grant delete on table "public"."QGIS" to "anon";

grant insert on table "public"."QGIS" to "anon";

grant references on table "public"."QGIS" to "anon";

grant select on table "public"."QGIS" to "anon";

grant trigger on table "public"."QGIS" to "anon";

grant truncate on table "public"."QGIS" to "anon";

grant update on table "public"."QGIS" to "anon";

grant delete on table "public"."QGIS" to "authenticated";

grant insert on table "public"."QGIS" to "authenticated";

grant references on table "public"."QGIS" to "authenticated";

grant select on table "public"."QGIS" to "authenticated";

grant trigger on table "public"."QGIS" to "authenticated";

grant truncate on table "public"."QGIS" to "authenticated";

grant update on table "public"."QGIS" to "authenticated";

grant delete on table "public"."QGIS" to "service_role";

grant insert on table "public"."QGIS" to "service_role";

grant references on table "public"."QGIS" to "service_role";

grant select on table "public"."QGIS" to "service_role";

grant trigger on table "public"."QGIS" to "service_role";

grant truncate on table "public"."QGIS" to "service_role";

grant update on table "public"."QGIS" to "service_role";

grant delete on table "public"."_migration_hotspot_mapping" to "anon";

grant insert on table "public"."_migration_hotspot_mapping" to "anon";

grant references on table "public"."_migration_hotspot_mapping" to "anon";

grant select on table "public"."_migration_hotspot_mapping" to "anon";

grant trigger on table "public"."_migration_hotspot_mapping" to "anon";

grant truncate on table "public"."_migration_hotspot_mapping" to "anon";

grant update on table "public"."_migration_hotspot_mapping" to "anon";

grant delete on table "public"."_migration_hotspot_mapping" to "authenticated";

grant insert on table "public"."_migration_hotspot_mapping" to "authenticated";

grant references on table "public"."_migration_hotspot_mapping" to "authenticated";

grant select on table "public"."_migration_hotspot_mapping" to "authenticated";

grant trigger on table "public"."_migration_hotspot_mapping" to "authenticated";

grant truncate on table "public"."_migration_hotspot_mapping" to "authenticated";

grant update on table "public"."_migration_hotspot_mapping" to "authenticated";

grant delete on table "public"."_migration_hotspot_mapping" to "service_role";

grant insert on table "public"."_migration_hotspot_mapping" to "service_role";

grant references on table "public"."_migration_hotspot_mapping" to "service_role";

grant select on table "public"."_migration_hotspot_mapping" to "service_role";

grant trigger on table "public"."_migration_hotspot_mapping" to "service_role";

grant truncate on table "public"."_migration_hotspot_mapping" to "service_role";

grant update on table "public"."_migration_hotspot_mapping" to "service_role";

grant delete on table "public"."_migration_location_to_visit" to "anon";

grant insert on table "public"."_migration_location_to_visit" to "anon";

grant references on table "public"."_migration_location_to_visit" to "anon";

grant select on table "public"."_migration_location_to_visit" to "anon";

grant trigger on table "public"."_migration_location_to_visit" to "anon";

grant truncate on table "public"."_migration_location_to_visit" to "anon";

grant update on table "public"."_migration_location_to_visit" to "anon";

grant delete on table "public"."_migration_location_to_visit" to "authenticated";

grant insert on table "public"."_migration_location_to_visit" to "authenticated";

grant references on table "public"."_migration_location_to_visit" to "authenticated";

grant select on table "public"."_migration_location_to_visit" to "authenticated";

grant trigger on table "public"."_migration_location_to_visit" to "authenticated";

grant truncate on table "public"."_migration_location_to_visit" to "authenticated";

grant update on table "public"."_migration_location_to_visit" to "authenticated";

grant delete on table "public"."_migration_location_to_visit" to "service_role";

grant insert on table "public"."_migration_location_to_visit" to "service_role";

grant references on table "public"."_migration_location_to_visit" to "service_role";

grant select on table "public"."_migration_location_to_visit" to "service_role";

grant trigger on table "public"."_migration_location_to_visit" to "service_role";

grant truncate on table "public"."_migration_location_to_visit" to "service_role";

grant update on table "public"."_migration_location_to_visit" to "service_role";

grant delete on table "public"."_migration_placemark_mapping" to "anon";

grant insert on table "public"."_migration_placemark_mapping" to "anon";

grant references on table "public"."_migration_placemark_mapping" to "anon";

grant select on table "public"."_migration_placemark_mapping" to "anon";

grant trigger on table "public"."_migration_placemark_mapping" to "anon";

grant truncate on table "public"."_migration_placemark_mapping" to "anon";

grant update on table "public"."_migration_placemark_mapping" to "anon";

grant delete on table "public"."_migration_placemark_mapping" to "authenticated";

grant insert on table "public"."_migration_placemark_mapping" to "authenticated";

grant references on table "public"."_migration_placemark_mapping" to "authenticated";

grant select on table "public"."_migration_placemark_mapping" to "authenticated";

grant trigger on table "public"."_migration_placemark_mapping" to "authenticated";

grant truncate on table "public"."_migration_placemark_mapping" to "authenticated";

grant update on table "public"."_migration_placemark_mapping" to "authenticated";

grant delete on table "public"."_migration_placemark_mapping" to "service_role";

grant insert on table "public"."_migration_placemark_mapping" to "service_role";

grant references on table "public"."_migration_placemark_mapping" to "service_role";

grant select on table "public"."_migration_placemark_mapping" to "service_role";

grant trigger on table "public"."_migration_placemark_mapping" to "service_role";

grant truncate on table "public"."_migration_placemark_mapping" to "service_role";

grant update on table "public"."_migration_placemark_mapping" to "service_role";

grant delete on table "public"."clip_embeddings" to "anon";

grant insert on table "public"."clip_embeddings" to "anon";

grant references on table "public"."clip_embeddings" to "anon";

grant select on table "public"."clip_embeddings" to "anon";

grant trigger on table "public"."clip_embeddings" to "anon";

grant truncate on table "public"."clip_embeddings" to "anon";

grant update on table "public"."clip_embeddings" to "anon";

grant delete on table "public"."clip_embeddings" to "authenticated";

grant insert on table "public"."clip_embeddings" to "authenticated";

grant references on table "public"."clip_embeddings" to "authenticated";

grant select on table "public"."clip_embeddings" to "authenticated";

grant trigger on table "public"."clip_embeddings" to "authenticated";

grant truncate on table "public"."clip_embeddings" to "authenticated";

grant update on table "public"."clip_embeddings" to "authenticated";

grant delete on table "public"."clip_embeddings" to "service_role";

grant insert on table "public"."clip_embeddings" to "service_role";

grant references on table "public"."clip_embeddings" to "service_role";

grant select on table "public"."clip_embeddings" to "service_role";

grant trigger on table "public"."clip_embeddings" to "service_role";

grant truncate on table "public"."clip_embeddings" to "service_role";

grant update on table "public"."clip_embeddings" to "service_role";

grant delete on table "public"."companies" to "anon";

grant insert on table "public"."companies" to "anon";

grant references on table "public"."companies" to "anon";

grant select on table "public"."companies" to "anon";

grant trigger on table "public"."companies" to "anon";

grant truncate on table "public"."companies" to "anon";

grant update on table "public"."companies" to "anon";

grant delete on table "public"."companies" to "authenticated";

grant insert on table "public"."companies" to "authenticated";

grant references on table "public"."companies" to "authenticated";

grant select on table "public"."companies" to "authenticated";

grant trigger on table "public"."companies" to "authenticated";

grant truncate on table "public"."companies" to "authenticated";

grant update on table "public"."companies" to "authenticated";

grant delete on table "public"."companies" to "service_role";

grant insert on table "public"."companies" to "service_role";

grant references on table "public"."companies" to "service_role";

grant select on table "public"."companies" to "service_role";

grant trigger on table "public"."companies" to "service_role";

grant truncate on table "public"."companies" to "service_role";

grant update on table "public"."companies" to "service_role";

grant delete on table "public"."export_jobs" to "anon";

grant insert on table "public"."export_jobs" to "anon";

grant references on table "public"."export_jobs" to "anon";

grant select on table "public"."export_jobs" to "anon";

grant trigger on table "public"."export_jobs" to "anon";

grant truncate on table "public"."export_jobs" to "anon";

grant update on table "public"."export_jobs" to "anon";

grant delete on table "public"."export_jobs" to "authenticated";

grant insert on table "public"."export_jobs" to "authenticated";

grant references on table "public"."export_jobs" to "authenticated";

grant select on table "public"."export_jobs" to "authenticated";

grant trigger on table "public"."export_jobs" to "authenticated";

grant truncate on table "public"."export_jobs" to "authenticated";

grant update on table "public"."export_jobs" to "authenticated";

grant delete on table "public"."export_jobs" to "service_role";

grant insert on table "public"."export_jobs" to "service_role";

grant references on table "public"."export_jobs" to "service_role";

grant select on table "public"."export_jobs" to "service_role";

grant trigger on table "public"."export_jobs" to "service_role";

grant truncate on table "public"."export_jobs" to "service_role";

grant update on table "public"."export_jobs" to "service_role";

grant delete on table "public"."hotspot_attachments" to "anon";

grant insert on table "public"."hotspot_attachments" to "anon";

grant references on table "public"."hotspot_attachments" to "anon";

grant select on table "public"."hotspot_attachments" to "anon";

grant trigger on table "public"."hotspot_attachments" to "anon";

grant truncate on table "public"."hotspot_attachments" to "anon";

grant update on table "public"."hotspot_attachments" to "anon";

grant delete on table "public"."hotspot_attachments" to "authenticated";

grant insert on table "public"."hotspot_attachments" to "authenticated";

grant references on table "public"."hotspot_attachments" to "authenticated";

grant select on table "public"."hotspot_attachments" to "authenticated";

grant trigger on table "public"."hotspot_attachments" to "authenticated";

grant truncate on table "public"."hotspot_attachments" to "authenticated";

grant update on table "public"."hotspot_attachments" to "authenticated";

grant delete on table "public"."hotspot_attachments" to "service_role";

grant insert on table "public"."hotspot_attachments" to "service_role";

grant references on table "public"."hotspot_attachments" to "service_role";

grant select on table "public"."hotspot_attachments" to "service_role";

grant trigger on table "public"."hotspot_attachments" to "service_role";

grant truncate on table "public"."hotspot_attachments" to "service_role";

grant update on table "public"."hotspot_attachments" to "service_role";

grant delete on table "public"."hotspots" to "anon";

grant insert on table "public"."hotspots" to "anon";

grant references on table "public"."hotspots" to "anon";

grant select on table "public"."hotspots" to "anon";

grant trigger on table "public"."hotspots" to "anon";

grant truncate on table "public"."hotspots" to "anon";

grant update on table "public"."hotspots" to "anon";

grant delete on table "public"."hotspots" to "authenticated";

grant insert on table "public"."hotspots" to "authenticated";

grant references on table "public"."hotspots" to "authenticated";

grant select on table "public"."hotspots" to "authenticated";

grant trigger on table "public"."hotspots" to "authenticated";

grant truncate on table "public"."hotspots" to "authenticated";

grant update on table "public"."hotspots" to "authenticated";

grant delete on table "public"."hotspots" to "service_role";

grant insert on table "public"."hotspots" to "service_role";

grant references on table "public"."hotspots" to "service_role";

grant select on table "public"."hotspots" to "service_role";

grant trigger on table "public"."hotspots" to "service_role";

grant truncate on table "public"."hotspots" to "service_role";

grant update on table "public"."hotspots" to "service_role";

grant delete on table "public"."panoramas" to "anon";

grant insert on table "public"."panoramas" to "anon";

grant references on table "public"."panoramas" to "anon";

grant select on table "public"."panoramas" to "anon";

grant trigger on table "public"."panoramas" to "anon";

grant truncate on table "public"."panoramas" to "anon";

grant update on table "public"."panoramas" to "anon";

grant delete on table "public"."panoramas" to "authenticated";

grant insert on table "public"."panoramas" to "authenticated";

grant references on table "public"."panoramas" to "authenticated";

grant select on table "public"."panoramas" to "authenticated";

grant trigger on table "public"."panoramas" to "authenticated";

grant truncate on table "public"."panoramas" to "authenticated";

grant update on table "public"."panoramas" to "authenticated";

grant delete on table "public"."panoramas" to "service_role";

grant insert on table "public"."panoramas" to "service_role";

grant references on table "public"."panoramas" to "service_role";

grant select on table "public"."panoramas" to "service_role";

grant trigger on table "public"."panoramas" to "service_role";

grant truncate on table "public"."panoramas" to "service_role";

grant update on table "public"."panoramas" to "service_role";

grant delete on table "public"."placemark_data_schemas" to "anon";

grant insert on table "public"."placemark_data_schemas" to "anon";

grant references on table "public"."placemark_data_schemas" to "anon";

grant select on table "public"."placemark_data_schemas" to "anon";

grant trigger on table "public"."placemark_data_schemas" to "anon";

grant truncate on table "public"."placemark_data_schemas" to "anon";

grant update on table "public"."placemark_data_schemas" to "anon";

grant delete on table "public"."placemark_data_schemas" to "authenticated";

grant insert on table "public"."placemark_data_schemas" to "authenticated";

grant references on table "public"."placemark_data_schemas" to "authenticated";

grant select on table "public"."placemark_data_schemas" to "authenticated";

grant trigger on table "public"."placemark_data_schemas" to "authenticated";

grant truncate on table "public"."placemark_data_schemas" to "authenticated";

grant update on table "public"."placemark_data_schemas" to "authenticated";

grant delete on table "public"."placemark_data_schemas" to "service_role";

grant insert on table "public"."placemark_data_schemas" to "service_role";

grant references on table "public"."placemark_data_schemas" to "service_role";

grant select on table "public"."placemark_data_schemas" to "service_role";

grant trigger on table "public"."placemark_data_schemas" to "service_role";

grant truncate on table "public"."placemark_data_schemas" to "service_role";

grant update on table "public"."placemark_data_schemas" to "service_role";

grant delete on table "public"."placemark_history" to "anon";

grant insert on table "public"."placemark_history" to "anon";

grant references on table "public"."placemark_history" to "anon";

grant select on table "public"."placemark_history" to "anon";

grant trigger on table "public"."placemark_history" to "anon";

grant truncate on table "public"."placemark_history" to "anon";

grant update on table "public"."placemark_history" to "anon";

grant delete on table "public"."placemark_history" to "authenticated";

grant insert on table "public"."placemark_history" to "authenticated";

grant references on table "public"."placemark_history" to "authenticated";

grant select on table "public"."placemark_history" to "authenticated";

grant trigger on table "public"."placemark_history" to "authenticated";

grant truncate on table "public"."placemark_history" to "authenticated";

grant update on table "public"."placemark_history" to "authenticated";

grant delete on table "public"."placemark_history" to "service_role";

grant insert on table "public"."placemark_history" to "service_role";

grant references on table "public"."placemark_history" to "service_role";

grant select on table "public"."placemark_history" to "service_role";

grant trigger on table "public"."placemark_history" to "service_role";

grant truncate on table "public"."placemark_history" to "service_role";

grant update on table "public"."placemark_history" to "service_role";

grant delete on table "public"."placemark_image_schema" to "anon";

grant insert on table "public"."placemark_image_schema" to "anon";

grant references on table "public"."placemark_image_schema" to "anon";

grant select on table "public"."placemark_image_schema" to "anon";

grant trigger on table "public"."placemark_image_schema" to "anon";

grant truncate on table "public"."placemark_image_schema" to "anon";

grant update on table "public"."placemark_image_schema" to "anon";

grant delete on table "public"."placemark_image_schema" to "authenticated";

grant insert on table "public"."placemark_image_schema" to "authenticated";

grant references on table "public"."placemark_image_schema" to "authenticated";

grant select on table "public"."placemark_image_schema" to "authenticated";

grant trigger on table "public"."placemark_image_schema" to "authenticated";

grant truncate on table "public"."placemark_image_schema" to "authenticated";

grant update on table "public"."placemark_image_schema" to "authenticated";

grant delete on table "public"."placemark_image_schema" to "service_role";

grant insert on table "public"."placemark_image_schema" to "service_role";

grant references on table "public"."placemark_image_schema" to "service_role";

grant select on table "public"."placemark_image_schema" to "service_role";

grant trigger on table "public"."placemark_image_schema" to "service_role";

grant truncate on table "public"."placemark_image_schema" to "service_role";

grant update on table "public"."placemark_image_schema" to "service_role";

grant delete on table "public"."placemark_images" to "anon";

grant insert on table "public"."placemark_images" to "anon";

grant references on table "public"."placemark_images" to "anon";

grant select on table "public"."placemark_images" to "anon";

grant trigger on table "public"."placemark_images" to "anon";

grant truncate on table "public"."placemark_images" to "anon";

grant update on table "public"."placemark_images" to "anon";

grant delete on table "public"."placemark_images" to "authenticated";

grant insert on table "public"."placemark_images" to "authenticated";

grant references on table "public"."placemark_images" to "authenticated";

grant select on table "public"."placemark_images" to "authenticated";

grant trigger on table "public"."placemark_images" to "authenticated";

grant truncate on table "public"."placemark_images" to "authenticated";

grant update on table "public"."placemark_images" to "authenticated";

grant delete on table "public"."placemark_images" to "service_role";

grant insert on table "public"."placemark_images" to "service_role";

grant references on table "public"."placemark_images" to "service_role";

grant select on table "public"."placemark_images" to "service_role";

grant trigger on table "public"."placemark_images" to "service_role";

grant truncate on table "public"."placemark_images" to "service_role";

grant update on table "public"."placemark_images" to "service_role";

grant delete on table "public"."placemarks" to "anon";

grant insert on table "public"."placemarks" to "anon";

grant references on table "public"."placemarks" to "anon";

grant select on table "public"."placemarks" to "anon";

grant trigger on table "public"."placemarks" to "anon";

grant truncate on table "public"."placemarks" to "anon";

grant update on table "public"."placemarks" to "anon";

grant delete on table "public"."placemarks" to "authenticated";

grant insert on table "public"."placemarks" to "authenticated";

grant references on table "public"."placemarks" to "authenticated";

grant select on table "public"."placemarks" to "authenticated";

grant trigger on table "public"."placemarks" to "authenticated";

grant truncate on table "public"."placemarks" to "authenticated";

grant update on table "public"."placemarks" to "authenticated";

grant delete on table "public"."placemarks" to "service_role";

grant insert on table "public"."placemarks" to "service_role";

grant references on table "public"."placemarks" to "service_role";

grant select on table "public"."placemarks" to "service_role";

grant trigger on table "public"."placemarks" to "service_role";

grant truncate on table "public"."placemarks" to "service_role";

grant update on table "public"."placemarks" to "service_role";

grant delete on table "public"."projects" to "anon";

grant insert on table "public"."projects" to "anon";

grant references on table "public"."projects" to "anon";

grant select on table "public"."projects" to "anon";

grant trigger on table "public"."projects" to "anon";

grant truncate on table "public"."projects" to "anon";

grant update on table "public"."projects" to "anon";

grant delete on table "public"."projects" to "authenticated";

grant insert on table "public"."projects" to "authenticated";

grant references on table "public"."projects" to "authenticated";

grant select on table "public"."projects" to "authenticated";

grant trigger on table "public"."projects" to "authenticated";

grant truncate on table "public"."projects" to "authenticated";

grant update on table "public"."projects" to "authenticated";

grant delete on table "public"."projects" to "service_role";

grant insert on table "public"."projects" to "service_role";

grant references on table "public"."projects" to "service_role";

grant select on table "public"."projects" to "service_role";

grant trigger on table "public"."projects" to "service_role";

grant truncate on table "public"."projects" to "service_role";

grant update on table "public"."projects" to "service_role";

grant delete on table "public"."reports" to "anon";

grant insert on table "public"."reports" to "anon";

grant references on table "public"."reports" to "anon";

grant select on table "public"."reports" to "anon";

grant trigger on table "public"."reports" to "anon";

grant truncate on table "public"."reports" to "anon";

grant update on table "public"."reports" to "anon";

grant delete on table "public"."reports" to "authenticated";

grant insert on table "public"."reports" to "authenticated";

grant references on table "public"."reports" to "authenticated";

grant select on table "public"."reports" to "authenticated";

grant trigger on table "public"."reports" to "authenticated";

grant truncate on table "public"."reports" to "authenticated";

grant update on table "public"."reports" to "authenticated";

grant delete on table "public"."reports" to "service_role";

grant insert on table "public"."reports" to "service_role";

grant references on table "public"."reports" to "service_role";

grant select on table "public"."reports" to "service_role";

grant trigger on table "public"."reports" to "service_role";

grant truncate on table "public"."reports" to "service_role";

grant update on table "public"."reports" to "service_role";

grant delete on table "public"."site_data" to "anon";

grant insert on table "public"."site_data" to "anon";

grant references on table "public"."site_data" to "anon";

grant select on table "public"."site_data" to "anon";

grant trigger on table "public"."site_data" to "anon";

grant truncate on table "public"."site_data" to "anon";

grant update on table "public"."site_data" to "anon";

grant delete on table "public"."site_data" to "authenticated";

grant insert on table "public"."site_data" to "authenticated";

grant references on table "public"."site_data" to "authenticated";

grant select on table "public"."site_data" to "authenticated";

grant trigger on table "public"."site_data" to "authenticated";

grant truncate on table "public"."site_data" to "authenticated";

grant update on table "public"."site_data" to "authenticated";

grant delete on table "public"."site_data" to "service_role";

grant insert on table "public"."site_data" to "service_role";

grant references on table "public"."site_data" to "service_role";

grant select on table "public"."site_data" to "service_role";

grant trigger on table "public"."site_data" to "service_role";

grant truncate on table "public"."site_data" to "service_role";

grant update on table "public"."site_data" to "service_role";

grant delete on table "public"."site_elements" to "anon";

grant insert on table "public"."site_elements" to "anon";

grant references on table "public"."site_elements" to "anon";

grant select on table "public"."site_elements" to "anon";

grant trigger on table "public"."site_elements" to "anon";

grant truncate on table "public"."site_elements" to "anon";

grant update on table "public"."site_elements" to "anon";

grant delete on table "public"."site_elements" to "authenticated";

grant insert on table "public"."site_elements" to "authenticated";

grant references on table "public"."site_elements" to "authenticated";

grant select on table "public"."site_elements" to "authenticated";

grant trigger on table "public"."site_elements" to "authenticated";

grant truncate on table "public"."site_elements" to "authenticated";

grant update on table "public"."site_elements" to "authenticated";

grant delete on table "public"."site_elements" to "service_role";

grant insert on table "public"."site_elements" to "service_role";

grant references on table "public"."site_elements" to "service_role";

grant select on table "public"."site_elements" to "service_role";

grant trigger on table "public"."site_elements" to "service_role";

grant truncate on table "public"."site_elements" to "service_role";

grant update on table "public"."site_elements" to "service_role";

grant delete on table "public"."sites" to "anon";

grant insert on table "public"."sites" to "anon";

grant references on table "public"."sites" to "anon";

grant select on table "public"."sites" to "anon";

grant trigger on table "public"."sites" to "anon";

grant truncate on table "public"."sites" to "anon";

grant update on table "public"."sites" to "anon";

grant delete on table "public"."sites" to "authenticated";

grant insert on table "public"."sites" to "authenticated";

grant references on table "public"."sites" to "authenticated";

grant select on table "public"."sites" to "authenticated";

grant trigger on table "public"."sites" to "authenticated";

grant truncate on table "public"."sites" to "authenticated";

grant update on table "public"."sites" to "authenticated";

grant delete on table "public"."sites" to "service_role";

grant insert on table "public"."sites" to "service_role";

grant references on table "public"."sites" to "service_role";

grant select on table "public"."sites" to "service_role";

grant trigger on table "public"."sites" to "service_role";

grant truncate on table "public"."sites" to "service_role";

grant update on table "public"."sites" to "service_role";

grant delete on table "public"."user_companies" to "anon";

grant insert on table "public"."user_companies" to "anon";

grant references on table "public"."user_companies" to "anon";

grant select on table "public"."user_companies" to "anon";

grant trigger on table "public"."user_companies" to "anon";

grant truncate on table "public"."user_companies" to "anon";

grant update on table "public"."user_companies" to "anon";

grant delete on table "public"."user_companies" to "authenticated";

grant insert on table "public"."user_companies" to "authenticated";

grant references on table "public"."user_companies" to "authenticated";

grant select on table "public"."user_companies" to "authenticated";

grant trigger on table "public"."user_companies" to "authenticated";

grant truncate on table "public"."user_companies" to "authenticated";

grant update on table "public"."user_companies" to "authenticated";

grant delete on table "public"."user_companies" to "service_role";

grant insert on table "public"."user_companies" to "service_role";

grant references on table "public"."user_companies" to "service_role";

grant select on table "public"."user_companies" to "service_role";

grant trigger on table "public"."user_companies" to "service_role";

grant truncate on table "public"."user_companies" to "service_role";

grant update on table "public"."user_companies" to "service_role";

grant delete on table "public"."user_roles" to "anon";

grant insert on table "public"."user_roles" to "anon";

grant references on table "public"."user_roles" to "anon";

grant select on table "public"."user_roles" to "anon";

grant trigger on table "public"."user_roles" to "anon";

grant truncate on table "public"."user_roles" to "anon";

grant update on table "public"."user_roles" to "anon";

grant delete on table "public"."user_roles" to "authenticated";

grant insert on table "public"."user_roles" to "authenticated";

grant references on table "public"."user_roles" to "authenticated";

grant select on table "public"."user_roles" to "authenticated";

grant trigger on table "public"."user_roles" to "authenticated";

grant truncate on table "public"."user_roles" to "authenticated";

grant update on table "public"."user_roles" to "authenticated";

grant delete on table "public"."user_roles" to "service_role";

grant insert on table "public"."user_roles" to "service_role";

grant references on table "public"."user_roles" to "service_role";

grant select on table "public"."user_roles" to "service_role";

grant trigger on table "public"."user_roles" to "service_role";

grant truncate on table "public"."user_roles" to "service_role";

grant update on table "public"."user_roles" to "service_role";

grant delete on table "public"."visit_records" to "anon";

grant insert on table "public"."visit_records" to "anon";

grant references on table "public"."visit_records" to "anon";

grant select on table "public"."visit_records" to "anon";

grant trigger on table "public"."visit_records" to "anon";

grant truncate on table "public"."visit_records" to "anon";

grant update on table "public"."visit_records" to "anon";

grant delete on table "public"."visit_records" to "authenticated";

grant insert on table "public"."visit_records" to "authenticated";

grant references on table "public"."visit_records" to "authenticated";

grant select on table "public"."visit_records" to "authenticated";

grant trigger on table "public"."visit_records" to "authenticated";

grant truncate on table "public"."visit_records" to "authenticated";

grant update on table "public"."visit_records" to "authenticated";

grant delete on table "public"."visit_records" to "service_role";

grant insert on table "public"."visit_records" to "service_role";

grant references on table "public"."visit_records" to "service_role";

grant select on table "public"."visit_records" to "service_role";

grant trigger on table "public"."visit_records" to "service_role";

grant truncate on table "public"."visit_records" to "service_role";

grant update on table "public"."visit_records" to "service_role";

grant delete on table "public"."visits" to "anon";

grant insert on table "public"."visits" to "anon";

grant references on table "public"."visits" to "anon";

grant select on table "public"."visits" to "anon";

grant trigger on table "public"."visits" to "anon";

grant truncate on table "public"."visits" to "anon";

grant update on table "public"."visits" to "anon";

grant delete on table "public"."visits" to "authenticated";

grant insert on table "public"."visits" to "authenticated";

grant references on table "public"."visits" to "authenticated";

grant select on table "public"."visits" to "authenticated";

grant trigger on table "public"."visits" to "authenticated";

grant truncate on table "public"."visits" to "authenticated";

grant update on table "public"."visits" to "authenticated";

grant delete on table "public"."visits" to "service_role";

grant insert on table "public"."visits" to "service_role";

grant references on table "public"."visits" to "service_role";

grant select on table "public"."visits" to "service_role";

grant trigger on table "public"."visits" to "service_role";

grant truncate on table "public"."visits" to "service_role";

grant update on table "public"."visits" to "service_role";


  create policy "QGIS test table - admin only"
  on "public"."QGIS"
  as permissive
  for all
  to authenticated
using (public.is_admin())
with check (public.is_admin());



  create policy "Migration tables - admin only"
  on "public"."_migration_location_to_visit"
  as permissive
  for all
  to authenticated
using (public.is_admin())
with check (public.is_admin());



  create policy "Migration tables - admin only"
  on "public"."_migration_placemark_mapping"
  as permissive
  for all
  to authenticated
using (public.is_admin())
with check (public.is_admin());



  create policy "Authorized users can access embeddings"
  on "public"."clip_embeddings"
  as permissive
  for all
  to authenticated
using ((EXISTS ( SELECT 1
   FROM (public.placemark_images pi
     JOIN public.placemarks p ON ((p.id = pi.placemark_id)))
  WHERE ((pi.id = clip_embeddings.placemark_image_id) AND (p.company_id = ANY (public.user_company_ids()))))))
with check ((EXISTS ( SELECT 1
   FROM (public.placemark_images pi
     JOIN public.placemarks p ON ((p.id = pi.placemark_id)))
  WHERE ((pi.id = clip_embeddings.placemark_image_id) AND (p.company_id = ANY (public.user_company_ids()))))));



  create policy "Admins can delete companies"
  on "public"."companies"
  as permissive
  for delete
  to authenticated
using ((public.is_admin() AND (id = ANY (public.user_company_ids()))));



  create policy "Admins can insert companies"
  on "public"."companies"
  as permissive
  for insert
  to authenticated
with check (public.is_admin());



  create policy "Admins can update companies"
  on "public"."companies"
  as permissive
  for update
  to authenticated
using ((id = ANY (public.user_company_ids())))
with check ((public.is_admin() AND (id = ANY (public.user_company_ids()))));



  create policy "Users can view accessible companies"
  on "public"."companies"
  as permissive
  for select
  to authenticated
using (((EXISTS ( SELECT 1
   FROM public.user_roles
  WHERE ((user_roles.user_id = ( SELECT auth.uid() AS uid)) AND (user_roles.role = 'ADMIN'::text)))) OR (id IN ( SELECT user_companies.company_id
   FROM public.user_companies
  WHERE (user_companies.user_id = ( SELECT auth.uid() AS uid))))));



  create policy "Users can view their companies"
  on "public"."companies"
  as permissive
  for select
  to authenticated
using ((id = ANY (public.user_company_ids())));



  create policy "Users can create export jobs"
  on "public"."export_jobs"
  as permissive
  for insert
  to authenticated
with check (((user_id = ( SELECT auth.uid() AS uid)) AND (EXISTS ( SELECT 1
   FROM (public.visits v
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((v.id = export_jobs.visit_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Users can delete their own export jobs"
  on "public"."export_jobs"
  as permissive
  for delete
  to authenticated
using ((user_id = ( SELECT auth.uid() AS uid)));



  create policy "Users can update their own export jobs"
  on "public"."export_jobs"
  as permissive
  for update
  to authenticated
using (((user_id = ( SELECT auth.uid() AS uid)) OR public.is_admin()))
with check (((user_id = ( SELECT auth.uid() AS uid)) OR public.is_admin()));



  create policy "Users can view their own export jobs"
  on "public"."export_jobs"
  as permissive
  for select
  to authenticated
using (((user_id = ( SELECT auth.uid() AS uid)) OR public.is_admin()));



  create policy "Admins can delete attachments"
  on "public"."hotspot_attachments"
  as permissive
  for delete
  to authenticated
using ((public.is_admin() AND (EXISTS ( SELECT 1
   FROM (((public.hotspots h
     JOIN public.panoramas pano ON ((pano.id = h.panorama_id)))
     JOIN public.visits v ON ((v.id = pano.visit_id)))
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((h.id = hotspot_attachments.hotspot_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Admins, PMs, and Field users can add attachments"
  on "public"."hotspot_attachments"
  as permissive
  for insert
  to authenticated
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text, 'FIELD'::text]) AND (EXISTS ( SELECT 1
   FROM (((public.hotspots h
     JOIN public.panoramas pano ON ((pano.id = h.panorama_id)))
     JOIN public.visits v ON ((v.id = pano.visit_id)))
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((h.id = hotspot_attachments.hotspot_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Admins, PMs, and Field users can update attachments"
  on "public"."hotspot_attachments"
  as permissive
  for update
  to authenticated
using ((EXISTS ( SELECT 1
   FROM (((public.hotspots h
     JOIN public.panoramas pano ON ((pano.id = h.panorama_id)))
     JOIN public.visits v ON ((v.id = pano.visit_id)))
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((h.id = hotspot_attachments.hotspot_id) AND (p.company_id = ANY (public.user_company_ids()))))))
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text, 'FIELD'::text]) AND (EXISTS ( SELECT 1
   FROM (((public.hotspots h
     JOIN public.panoramas pano ON ((pano.id = h.panorama_id)))
     JOIN public.visits v ON ((v.id = pano.visit_id)))
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((h.id = hotspot_attachments.hotspot_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Users can view attachments from their company"
  on "public"."hotspot_attachments"
  as permissive
  for select
  to authenticated
using ((EXISTS ( SELECT 1
   FROM (((public.hotspots h
     JOIN public.panoramas pano ON ((pano.id = h.panorama_id)))
     JOIN public.visits v ON ((v.id = pano.visit_id)))
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((h.id = hotspot_attachments.hotspot_id) AND (p.company_id = ANY (public.user_company_ids()))))));



  create policy "Admins can delete hotspots"
  on "public"."hotspots"
  as permissive
  for delete
  to authenticated
using ((public.is_admin() AND (EXISTS ( SELECT 1
   FROM ((public.panoramas pano
     JOIN public.visits v ON ((v.id = pano.visit_id)))
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((pano.id = hotspots.panorama_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Admins, PMs, and Field users can insert hotspots"
  on "public"."hotspots"
  as permissive
  for insert
  to authenticated
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text, 'FIELD'::text]) AND (EXISTS ( SELECT 1
   FROM ((public.panoramas pano
     JOIN public.visits v ON ((v.id = pano.visit_id)))
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((pano.id = hotspots.panorama_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Admins, PMs, and Field users can update hotspots"
  on "public"."hotspots"
  as permissive
  for update
  to authenticated
using ((EXISTS ( SELECT 1
   FROM ((public.panoramas pano
     JOIN public.visits v ON ((v.id = pano.visit_id)))
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((pano.id = hotspots.panorama_id) AND (p.company_id = ANY (public.user_company_ids()))))))
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text, 'FIELD'::text]) AND (EXISTS ( SELECT 1
   FROM ((public.panoramas pano
     JOIN public.visits v ON ((v.id = pano.visit_id)))
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((pano.id = hotspots.panorama_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Users can view hotspots from their company"
  on "public"."hotspots"
  as permissive
  for select
  to authenticated
using ((EXISTS ( SELECT 1
   FROM ((public.panoramas pano
     JOIN public.visits v ON ((v.id = pano.visit_id)))
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((pano.id = hotspots.panorama_id) AND (p.company_id = ANY (public.user_company_ids()))))));



  create policy "Admins can delete panoramas"
  on "public"."panoramas"
  as permissive
  for delete
  to authenticated
using ((public.is_admin() AND (EXISTS ( SELECT 1
   FROM (public.visits v
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((v.id = panoramas.visit_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Admins, PMs, and Field users can insert panoramas"
  on "public"."panoramas"
  as permissive
  for insert
  to authenticated
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text, 'FIELD'::text]) AND (EXISTS ( SELECT 1
   FROM (public.visits v
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((v.id = panoramas.visit_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Admins, PMs, and Field users can update panoramas"
  on "public"."panoramas"
  as permissive
  for update
  to authenticated
using ((EXISTS ( SELECT 1
   FROM (public.visits v
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((v.id = panoramas.visit_id) AND (p.company_id = ANY (public.user_company_ids()))))))
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text, 'FIELD'::text]) AND (EXISTS ( SELECT 1
   FROM (public.visits v
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((v.id = panoramas.visit_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Cannot access deleted panoramas"
  on "public"."panoramas"
  as restrictive
  for select
  to authenticated
using (((deleted_at IS NULL) OR public.is_admin()));



  create policy "Users can view panoramas from their company"
  on "public"."panoramas"
  as permissive
  for select
  to authenticated
using ((EXISTS ( SELECT 1
   FROM (public.visits v
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((v.id = panoramas.visit_id) AND (p.company_id = ANY (public.user_company_ids()))))));



  create policy "Admins can delete schemas"
  on "public"."placemark_data_schemas"
  as permissive
  for delete
  to authenticated
using ((public.is_admin() AND (company_id = ANY (public.user_company_ids()))));



  create policy "Admins can insert schemas"
  on "public"."placemark_data_schemas"
  as permissive
  for insert
  to authenticated
with check ((public.is_admin() AND (company_id = ANY (public.user_company_ids()))));



  create policy "Admins can update schemas"
  on "public"."placemark_data_schemas"
  as permissive
  for update
  to authenticated
using ((company_id = ANY (public.user_company_ids())))
with check ((public.is_admin() AND (company_id = ANY (public.user_company_ids()))));



  create policy "Users can view their company schemas"
  on "public"."placemark_data_schemas"
  as permissive
  for select
  to authenticated
using ((company_id = ANY (public.user_company_ids())));



  create policy "System can insert history"
  on "public"."placemark_history"
  as permissive
  for insert
  to authenticated
with check ((EXISTS ( SELECT 1
   FROM public.placemarks p
  WHERE ((p.id = placemark_history.placemark_id) AND (p.company_id = ANY (public.user_company_ids()))))));



  create policy "Users can view history from their company"
  on "public"."placemark_history"
  as permissive
  for select
  to authenticated
using ((EXISTS ( SELECT 1
   FROM public.placemarks p
  WHERE ((p.id = placemark_history.placemark_id) AND (p.company_id = ANY (public.user_company_ids()))))));



  create policy "Admins can delete image schemas"
  on "public"."placemark_image_schema"
  as permissive
  for delete
  to authenticated
using ((public.is_admin() AND (company_id = ANY (public.user_company_ids()))));



  create policy "Admins can insert image schemas"
  on "public"."placemark_image_schema"
  as permissive
  for insert
  to authenticated
with check ((public.is_admin() AND (company_id = ANY (public.user_company_ids()))));



  create policy "Admins can update image schemas"
  on "public"."placemark_image_schema"
  as permissive
  for update
  to authenticated
using ((company_id = ANY (public.user_company_ids())))
with check ((public.is_admin() AND (company_id = ANY (public.user_company_ids()))));



  create policy "Users can view their company image schemas"
  on "public"."placemark_image_schema"
  as permissive
  for select
  to authenticated
using ((company_id = ANY (public.user_company_ids())));



  create policy "Admins and owners can delete images"
  on "public"."placemark_images"
  as permissive
  for delete
  to authenticated
using (((public.is_admin() OR (uploaded_by = ( SELECT auth.uid() AS uid))) AND (EXISTS ( SELECT 1
   FROM public.placemarks p
  WHERE ((p.id = placemark_images.placemark_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Authorized users can update images"
  on "public"."placemark_images"
  as permissive
  for update
  to authenticated
using ((EXISTS ( SELECT 1
   FROM public.placemarks p
  WHERE ((p.id = placemark_images.placemark_id) AND (p.company_id = ANY (public.user_company_ids()))))))
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text, 'CONTRACTOR'::text, 'SUBCONTRACTOR'::text, 'FIELD'::text]) AND (EXISTS ( SELECT 1
   FROM public.placemarks p
  WHERE ((p.id = placemark_images.placemark_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Authorized users can upload images"
  on "public"."placemark_images"
  as permissive
  for insert
  to authenticated
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text, 'CONTRACTOR'::text, 'SUBCONTRACTOR'::text, 'FIELD'::text]) AND (EXISTS ( SELECT 1
   FROM public.placemarks p
  WHERE ((p.id = placemark_images.placemark_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Users can view images from their company"
  on "public"."placemark_images"
  as permissive
  for select
  to authenticated
using ((EXISTS ( SELECT 1
   FROM public.placemarks p
  WHERE ((p.id = placemark_images.placemark_id) AND (p.company_id = ANY (public.user_company_ids()))))));



  create policy "Admins can delete placemarks"
  on "public"."placemarks"
  as permissive
  for delete
  to authenticated
using ((public.is_admin() AND (company_id = ANY (public.user_company_ids()))));



  create policy "Authorized users can insert placemarks"
  on "public"."placemarks"
  as permissive
  for insert
  to authenticated
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text, 'CONTRACTOR'::text, 'SUBCONTRACTOR'::text, 'FIELD'::text]) AND (company_id = ANY (public.user_company_ids()))));



  create policy "Authorized users can update placemarks"
  on "public"."placemarks"
  as permissive
  for update
  to authenticated
using ((company_id = ANY (public.user_company_ids())))
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text, 'CONTRACTOR'::text, 'SUBCONTRACTOR'::text]) AND (company_id = ANY (public.user_company_ids()))));



  create policy "Cannot access deleted placemarks"
  on "public"."placemarks"
  as restrictive
  for select
  to authenticated
using (((deleted_at IS NULL) OR public.is_admin()));



  create policy "Users can view their company placemarks"
  on "public"."placemarks"
  as permissive
  for select
  to authenticated
using ((company_id = ANY (public.user_company_ids())));



  create policy "Admins and PMs can insert projects"
  on "public"."projects"
  as permissive
  for insert
  to authenticated
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text]) AND (company_id = ANY (public.user_company_ids()))));



  create policy "Admins and PMs can update projects"
  on "public"."projects"
  as permissive
  for update
  to authenticated
using ((company_id = ANY (public.user_company_ids())))
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text]) AND (company_id = ANY (public.user_company_ids()))));



  create policy "Admins can delete projects"
  on "public"."projects"
  as permissive
  for delete
  to authenticated
using ((public.is_admin() AND (company_id = ANY (public.user_company_ids()))));



  create policy "Users can view their company projects"
  on "public"."projects"
  as permissive
  for select
  to authenticated
using ((company_id = ANY (public.user_company_ids())));



  create policy "reports_insert_policy"
  on "public"."reports"
  as permissive
  for insert
  to public
with check ((EXISTS ( SELECT 1
   FROM (public.user_companies cu
     JOIN public.user_roles ur ON ((cu.user_id = ur.user_id)))
  WHERE ((cu.company_id = reports.company_id) AND (cu.user_id = auth.uid()) AND (ur.role = ANY (ARRAY['ADMIN'::text, 'PM'::text]))))));



  create policy "reports_select_policy"
  on "public"."reports"
  as permissive
  for select
  to public
using ((EXISTS ( SELECT 1
   FROM public.user_companies cu
  WHERE ((cu.company_id = reports.company_id) AND (cu.user_id = auth.uid())))));



  create policy "Only admins can delete their company site_data"
  on "public"."site_data"
  as permissive
  for delete
  to authenticated
using (((company_id IN ( SELECT user_companies.company_id
   FROM public.user_companies
  WHERE (user_companies.user_id = auth.uid()))) AND (EXISTS ( SELECT 1
   FROM public.user_roles
  WHERE ((user_roles.user_id = auth.uid()) AND (user_roles.role = 'ADMIN'::text))))));



  create policy "Users can create site_data for their company"
  on "public"."site_data"
  as permissive
  for insert
  to authenticated
with check ((company_id IN ( SELECT user_companies.company_id
   FROM public.user_companies
  WHERE (user_companies.user_id = auth.uid()))));



  create policy "Users can update their company site_data"
  on "public"."site_data"
  as permissive
  for update
  to authenticated
using ((company_id IN ( SELECT user_companies.company_id
   FROM public.user_companies
  WHERE (user_companies.user_id = auth.uid()))))
with check ((company_id IN ( SELECT user_companies.company_id
   FROM public.user_companies
  WHERE (user_companies.user_id = auth.uid()))));



  create policy "Users can view their company site_data"
  on "public"."site_data"
  as permissive
  for select
  to authenticated
using ((company_id IN ( SELECT user_companies.company_id
   FROM public.user_companies
  WHERE (user_companies.user_id = auth.uid()))));



  create policy "Authenticated users can create sites"
  on "public"."sites"
  as permissive
  for insert
  to authenticated
with check (true);



  create policy "Authenticated users can update sites"
  on "public"."sites"
  as permissive
  for update
  to authenticated
using (true)
with check (true);



  create policy "Users can view all sites"
  on "public"."sites"
  as permissive
  for select
  to authenticated
using (true);



  create policy "Admins can delete user company relationships"
  on "public"."user_companies"
  as permissive
  for delete
  to authenticated
using ((EXISTS ( SELECT 1
   FROM public.user_roles
  WHERE ((user_roles.user_id = ( SELECT auth.uid() AS uid)) AND (user_roles.role = 'ADMIN'::text)))));



  create policy "Admins can insert user company relationships"
  on "public"."user_companies"
  as permissive
  for insert
  to authenticated
with check ((EXISTS ( SELECT 1
   FROM public.user_roles
  WHERE ((user_roles.user_id = ( SELECT auth.uid() AS uid)) AND (user_roles.role = 'ADMIN'::text)))));



  create policy "Admins can update user company relationships"
  on "public"."user_companies"
  as permissive
  for update
  to authenticated
using ((EXISTS ( SELECT 1
   FROM public.user_roles
  WHERE ((user_roles.user_id = ( SELECT auth.uid() AS uid)) AND (user_roles.role = 'ADMIN'::text)))))
with check ((EXISTS ( SELECT 1
   FROM public.user_roles
  WHERE ((user_roles.user_id = ( SELECT auth.uid() AS uid)) AND (user_roles.role = 'ADMIN'::text)))));



  create policy "Users can view accessible user company relationships"
  on "public"."user_companies"
  as permissive
  for select
  to authenticated
using (((EXISTS ( SELECT 1
   FROM public.user_roles
  WHERE ((user_roles.user_id = ( SELECT auth.uid() AS uid)) AND (user_roles.role = 'ADMIN'::text)))) OR (user_id = ( SELECT auth.uid() AS uid))));



  create policy "Admins can delete user roles"
  on "public"."user_roles"
  as permissive
  for delete
  to authenticated
using ((EXISTS ( SELECT 1
   FROM public.user_roles user_roles_1
  WHERE ((user_roles_1.user_id = ( SELECT auth.uid() AS uid)) AND (user_roles_1.role = 'ADMIN'::text)))));



  create policy "Admins can insert user roles"
  on "public"."user_roles"
  as permissive
  for insert
  to authenticated
with check ((EXISTS ( SELECT 1
   FROM public.user_roles user_roles_1
  WHERE ((user_roles_1.user_id = ( SELECT auth.uid() AS uid)) AND (user_roles_1.role = 'ADMIN'::text)))));



  create policy "Admins can update user roles"
  on "public"."user_roles"
  as permissive
  for update
  to authenticated
using ((EXISTS ( SELECT 1
   FROM public.user_roles user_roles_1
  WHERE ((user_roles_1.user_id = ( SELECT auth.uid() AS uid)) AND (user_roles_1.role = 'ADMIN'::text)))))
with check ((EXISTS ( SELECT 1
   FROM public.user_roles user_roles_1
  WHERE ((user_roles_1.user_id = ( SELECT auth.uid() AS uid)) AND (user_roles_1.role = 'ADMIN'::text)))));



  create policy "Users can view their own roles"
  on "public"."user_roles"
  as permissive
  for select
  to authenticated
using ((user_id = ( SELECT auth.uid() AS uid)));



  create policy "Admins can delete visit records"
  on "public"."visit_records"
  as permissive
  for delete
  to authenticated
using ((public.is_admin() AND (EXISTS ( SELECT 1
   FROM (public.visits v
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((v.id = visit_records.visit_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Authorized users can create visit records"
  on "public"."visit_records"
  as permissive
  for insert
  to authenticated
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text, 'CONTRACTOR'::text, 'SUBCONTRACTOR'::text, 'FIELD'::text]) AND (EXISTS ( SELECT 1
   FROM (public.visits v
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((v.id = visit_records.visit_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Authorized users can update visit records"
  on "public"."visit_records"
  as permissive
  for update
  to authenticated
using ((EXISTS ( SELECT 1
   FROM (public.visits v
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((v.id = visit_records.visit_id) AND (p.company_id = ANY (public.user_company_ids()))))))
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text, 'CONTRACTOR'::text, 'SUBCONTRACTOR'::text, 'FIELD'::text]) AND (EXISTS ( SELECT 1
   FROM (public.visits v
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((v.id = visit_records.visit_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Cannot access deleted visit records"
  on "public"."visit_records"
  as restrictive
  for select
  to authenticated
using (((deleted_at IS NULL) OR public.is_admin()));



  create policy "Users can view visit records from their company"
  on "public"."visit_records"
  as permissive
  for select
  to authenticated
using ((EXISTS ( SELECT 1
   FROM (public.visits v
     JOIN public.projects p ON ((p.id = v.project_id)))
  WHERE ((v.id = visit_records.visit_id) AND (p.company_id = ANY (public.user_company_ids()))))));



  create policy "Admins and PMs can create visits"
  on "public"."visits"
  as permissive
  for insert
  to authenticated
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text]) AND (EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = visits.project_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Admins and PMs can update visits"
  on "public"."visits"
  as permissive
  for update
  to authenticated
using ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = visits.project_id) AND (p.company_id = ANY (public.user_company_ids()))))))
with check ((public.user_has_role(ARRAY['ADMIN'::text, 'PM'::text]) AND (EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = visits.project_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Admins can delete visits"
  on "public"."visits"
  as permissive
  for delete
  to authenticated
using ((public.is_admin() AND (EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = visits.project_id) AND (p.company_id = ANY (public.user_company_ids())))))));



  create policy "Users can view visits from their company projects"
  on "public"."visits"
  as permissive
  for select
  to authenticated
using ((EXISTS ( SELECT 1
   FROM public.projects p
  WHERE ((p.id = visits.project_id) AND (p.company_id = ANY (public.user_company_ids()))))));



  create policy "Give users authenticated access to folder 1y077dz_0"
  on "storage"."objects"
  as permissive
  for insert
  to authenticated
with check (((bucket_id = 'company-files'::text) AND ((storage.foldername(name))[1] = 'private'::text) AND (auth.role() = 'authenticated'::text)));



  create policy "Give users authenticated access to folder 1y077dz_1"
  on "storage"."objects"
  as permissive
  for select
  to authenticated
using (((bucket_id = 'company-files'::text) AND ((storage.foldername(name))[1] = 'private'::text) AND (auth.role() = 'authenticated'::text)));



  create policy "Give users authenticated access to folder 1y077dz_2"
  on "storage"."objects"
  as permissive
  for delete
  to authenticated
using (((bucket_id = 'company-files'::text) AND ((storage.foldername(name))[1] = 'private'::text) AND (auth.role() = 'authenticated'::text)));



  create policy "Give users authenticated access to folder 1y077dz_3"
  on "storage"."objects"
  as permissive
  for update
  to authenticated
using (((bucket_id = 'company-files'::text) AND ((storage.foldername(name))[1] = 'private'::text) AND (auth.role() = 'authenticated'::text)));



